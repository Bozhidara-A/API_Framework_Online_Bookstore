name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/upload-artifact@v4


      - name: Build Docker image
        run: docker build -t api-tests .

      - name: Run tests in container
        run: docker run --name test-container api-tests

      - name: Copy Allure results from container
        run: docker cp test-container:/app/target/allure-results ./allure-results

      - name: Generate Allure report
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/allure-results:/app/allure-results \
            -v ${{ github.workspace }}/allure-report:/app/allure-report \
            frankescobar/allure-docker-service generate

      - name: Upload Allure report
        uses: actions/upload-artifact@v3
        with:
          name: allure-report
          path: allure-report

      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report

      - name: Cleanup Docker Container
        run: docker rm test-container
